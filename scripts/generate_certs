#!/usr/bin/env bash

set -euo pipefail

# Collocating certs with the agent server main for local development
pushd cmd/agent-api

echo "Generating CA key and certificate..."

# Generate CA private key
openssl genrsa -out ca.key.pem 4096

# Generate self-signed CA certificate
openssl req -x509 -new -nodes -key ca.key.pem -sha256 -days 3650 \
  -subj "/CN=Packet Sentry CA" \
  -out ca.cert.pem

echo "Generating server key and certificate..."

# Generate server private key
openssl genrsa -out server.key.pem 2048

# Generate server certificate signing request
openssl req -new -key server.key.pem -subj "/CN=localhost" -out server.csr.pem

# Create a SAN config for the server certificate
cat > server_ext.cnf <<EOF
subjectAltName = DNS:localhost
EOF

# Self-sign the server certificate using the CA and add SAN
openssl x509 -req -in server.csr.pem -CA ca.cert.pem -CAkey ca.key.pem \
  -CAcreateserial -out server.cert.pem -days 365 -sha256 \
  -extfile server_ext.cnf

echo "All certificates and keys generated:"
echo "- CA cert/key:           ca.cert.pem / ca.key.pem"
echo "- Server cert/key:       server.cert.pem / server.key.pem"

popd